<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title><![CDATA[rtoheaven's blog]]></title>
  <subtitle><![CDATA[Walk steps step by step]]></subtitle>
  <link href="/atom.xml" rel="self"/>
  <link href="http://yoursite.com/"/>
  <updated>2014-11-05T03:41:16.079Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name><![CDATA[rtoheaven]]></name>
    <email><![CDATA[rtoheaven@163.com]]></email>
  </author>
  
  <generator uri="http://zespia.tw/hexo/">Hexo</generator>
  
  <entry>
    <title><![CDATA[windows常见反调试]]></title>
    <link href="http://yoursite.com/2014/11/05/C%E8%AF%AD%E8%A8%80%E6%93%8D%E4%BD%9CSQLITE3%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    <id>http://yoursite.com/2014/11/05/C语言操作SQLITE3数据库/</id>
    <published>2014-11-05T03:31:56.000Z</published>
    <updated>2014-11-05T03:41:08.000Z</updated>
    <content type="html"><![CDATA[<h2 id="一、版本">一、版本</h2>
<p>从 www.sqlite.org 网站可下载到最新的 sqlite 代码和编译版本。我写此文章时，最新代码是 3.3.17 版本。<br>很久没有去下载 sqlite 新代码，因此也不知道 sqlite 变化这么大。以前很多文件，现在全部合并成一个 sqlite3.c 文件。<br>如果单独用此文件，是挺好的，省去拷贝一堆文件还担心有没有遗漏。但是也带来一个问题：此文件太大，快接近7万行代码，VC开它整个机器都慢下来 了。<br>如果不需要改它代码，也就不需要打开 sqlite3.c 文件，机器不会慢。但是，下面我要写通过修改 sqlite 代码完成加密功能，那时候就比较痛苦了。</p>
<h2 id="二、基本编译">二、基本编译</h2>
<p>这个不想多说了，在 VC 里新建 dos 控制台空白工程，把 sqlite3.c 和 sqlite3.h 添加到工程，再新建一个 main.cpp 文件。在里面写:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">extern</span> “C”</div><div class="line">{</div><div class="line"><span class="preprocessor">#include “./sqlite3.h”</span></div><div class="line">};</div><div class="line"><span class="keyword">int</span> main( <span class="keyword">int</span> , <span class="keyword">char</span>** )</div><div class="line">{</div><div class="line"><span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">}</div></pre></td></tr></table></figure>

<p>为什么要 extern “C” ？如果问这个问题，我不想说太多，这是C++的基础。要在 C++ 里使用一段 C 的代码，必须要用 extern “C” 括起来。<br>C++跟 C虽然语法上有重叠，但是它们是两个不同的东西，内存里的布局是完全不同的，在C++编译器里不用extern “C”括起C代码，会导致编译器不知道该如何为 C 代码描述内存布局。<br>可能在 sqlite3.c 里人家已经把整段代码都 extern “C” 括起来了，但是你遇到一个 .c 文件就自觉的再括一次，也没什么不好。<br>基本工程就这样建立起来了。编译，可以通过。但是有一堆的 warning。可以不管它。</p>
<h2 id="三、SQLITE操作入门">三、SQLITE操作入门</h2>
<p>sqlite提供的是一些C函数接口，你可以用这些函数操作数据库。通过使用这些接口，传递一些标准 sql 语句（以 char * 类型）给 sqlite 函数，sqlite 就会为你操作数据库。<br>sqlite 跟MS的access一样是文件型数据库，就是说，一个数据库就是一个文件，此数据库里可以建立很多的表，可以建立索引、触发器等等，但是，它实际上得到的就是一个文件。<br>备份这个文件就备份了整个数据库。sqlite 不需要任何数据库引擎，这意味着如果你需要 sqlite 来保存一些用户数据，甚至都不需要安装数据库。<br>下面开始介绍数据库基本操作。</p>
<h3 id="1_基本流程（1）关键数据结构">1 基本流程（1）关键数据结构</h3>
<p>sqlite 里最常用到的是sqlite3 <em> 类型。从数据库打开开始，sqlite就要为这个类型准备好内存，直到数据库关闭，整个过程都需要用到这个类型.<br>当数据库打开时开始，这个类型的变量就代表了你要操作的数据库。下面再详细介绍。<br>（2）打开数据库<br>int sqlite3_open( 文件名, sqlite3 <em>* );<br>用这个函数开始数据库操作。<br>需要传入两个参数，一是数据库文件名，比如：c:\DongChunGuang_Database.db。<br>文件名不需要一定存在，如果此文件不存在，sqlite 会自动建立它。如果它存在，就尝试把它当数据库文件来打开。<br>sqlite3 </em></em> 参数即前面提到的关键数据结构。这个结构底层细节如何，你不要关它。<br>函数返回值表示操作是否正确，如果是SQLITE_OK 则表示操作正常。相关的返回值sqlite定义了一些宏。具体这些宏的含义可以参考 sqlite3.h 文件。<br>里面有详细定义（顺便说一下，sqlite3 的代码注释率自称是非常高的，实际上也的确很高。只要你会看英文，sqlite 可以让你学到不少东西）。<br>下面介绍关闭数据库后，再给一段参考代码。<br>（3）关闭数据库</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> sqlite3_close(sqlite3 *);</div><div class="line">前面如果用 sqlite3_open 开启了一个数据库，结尾时不要忘了用这个函数关闭数据库。</div><div class="line">下面给段简单的代码：</div><div class="line"><span class="keyword">extern</span> “C”</div><div class="line">{</div><div class="line"><span class="preprocessor">#include “./sqlite3.h”</span></div><div class="line">};</div><div class="line"><span class="keyword">int</span> main( <span class="keyword">int</span> , <span class="keyword">char</span>** )</div><div class="line">{</div><div class="line">sqlite3 * db = NULL; <span class="comment">//声明sqlite关键结构指针</span></div><div class="line"><span class="keyword">int</span> result;</div><div class="line"></div><div class="line"><span class="comment">//打开数据库</span></div><div class="line"><span class="comment">//需要传入 db 这个指针的指针，因为 sqlite3_open 函数要为这个指针分配内存，还要让db指针指向这个内存区</span></div><div class="line">result = sqlite3_open( “c:\Dcg_database.db”, &db );</div><div class="line"><span class="keyword">if</span>( result != SQLITE_OK )</div><div class="line">{</div><div class="line"><span class="comment">//数据库打开失败</span></div><div class="line"><span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line">}</div><div class="line"><span class="comment">//数据库操作代码</span></div><div class="line"><span class="comment">//…</span></div><div class="line"></div><div class="line"><span class="comment">//数据库打开成功</span></div><div class="line"><span class="comment">//关闭数据库</span></div><div class="line">sqlite3_close( db );</div><div class="line"><span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">}</div></pre></td></tr></table></figure>

<p>这就是一次数据库操作过程。</p>
<h3 id="2_SQL语句操作">2 SQL语句操作</h3>
<p>本节介绍如何用sqlite 执行标准 sql 语法。</p>
<p>（1）执行sql语句</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> sqlite3_exec(sqlite3*, <span class="keyword">const</span> <span class="keyword">char</span> *sql, sqlite3_callback, <span class="keyword">void</span> *,  <span class="keyword">char</span> **errmsg );</div><div class="line">这就是执行一条 sql 语句的函数。</div><div class="line">第<span class="number">1</span>个参数不再说了，是前面open函数得到的指针。说了是关键数据结构。</div><div class="line">第<span class="number">2</span>个参数<span class="keyword">const</span> <span class="keyword">char</span> *sql 是一条 sql 语句，以\<span class="number">0</span>结尾。</div><div class="line">第<span class="number">3</span>个参数sqlite3_callback 是回调，当这条语句执行之后，sqlite3会去调用你提供的这个函数。（什么是回调函数，自己找别的资料学习）</div><div class="line">第<span class="number">4</span>个参数<span class="keyword">void</span> * 是你所提供的指针，你可以传递任何一个指针参数到这里，这个参数最终会传到回调函数里面，如果不需要传递指针给回调函数，可以填NULL。</div><div class="line">等下我们再看回调函数的写法，以及这个参数的使用。</div><div class="line">第 <span class="number">5</span>个参数<span class="keyword">char</span> ** errmsg 是错误信息。注意是指针的指针。</div><div class="line">sqlite3里面有很多固定的错误信息。执行 sqlite3_exec 之后，执行失败时可以查阅这个指针（直接 <span class="built_in">printf</span>(“%s\n”,errmsg)）得到一串字符串信息，这串信息告诉你错在什么地方。</div><div class="line">sqlite3_exec函数通过修改你传入的指针的指 针，把你提供的指针指向错误提示信息，这样sqlite3_exec函数外面就可以通过这个 <span class="keyword">char</span>*得到具体错误提示。</div><div class="line">说明：通常，sqlite3_callback 和它后面的 <span class="keyword">void</span> * 这两个位置都可以填 NULL。</div><div class="line">填NULL表示你不需要回调。比如你做 insert 操作，做 <span class="keyword">delete</span> 操作，就没有必要使用回调。而当你做 select 时，就要使用回调，因为 sqlite3 把数据查出来，得通过回调告诉你查出了什么数据。</div></pre></td></tr></table></figure>

<p>（2）exec 的回调</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">int</span> (*sqlite3_callback)(<span class="keyword">void</span>*,<span class="keyword">int</span>,<span class="keyword">char</span>**, <span class="keyword">char</span>**);</div><div class="line">你的回调函数必须定义成上面这个函数的类型。下面给个简单的例子：</div><div class="line"><span class="comment">//sqlite3的回调函数</span></div><div class="line"><span class="comment">// sqlite 每查到一条记录，就调用一次这个回调</span></div><div class="line"><span class="keyword">int</span> LoadMyInfo( <span class="keyword">void</span> * para, <span class="keyword">int</span> n_column, <span class="keyword">char</span> ** column_value, <span class="keyword">char</span> ** column_name )</div><div class="line">{</div><div class="line"><span class="comment">//para是你在 sqlite3_exec 里传入的 void * 参数</span></div><div class="line"><span class="comment">//通过para参数，你可以传入一些特殊的指针（比如类指针、结构指针），然后在这里面强制转换成对应的类型（这里面是void*类型，必须强制转换成你的类型才可用）。然后操作这些数据</span></div><div class="line"><span class="comment">//n_column是这一条记录有多少个字段 (即这条记录有多少列)</span></div><div class="line"><span class="comment">// char ** column_value 是个关键值，查出来的数据都保存在这里，它实际上是个1维数组（不要以为是2维数组），每一个元素都是一个 char * 值，是一个字段内容（用字符串来表示，以\0结尾）</span></div><div class="line"></div><div class="line"><span class="comment">//char ** column_name 跟 column_value是对应的，表示这个字段的字段名称</span></div><div class="line"></div><div class="line"><span class="comment">//这里，我不使用 para 参数。忽略它的存在.</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> i;</div><div class="line"></div><div class="line"><span class="built_in">printf</span>( “记录包含 %d 个字段\n”, n_column );</div><div class="line"><span class="keyword">for</span>( i = <span class="number">0</span> ; i &lt; n_column; i ++ )</div><div class="line">{</div><div class="line"><span class="built_in">printf</span>( “字段名:%s  ?&gt; 字段值:%s\n”,  column_name[i], column_value[i] );</div><div class="line">}</div><div class="line"><span class="built_in">printf</span>( “——————\n“ );</div><div class="line"><span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">int</span> main( <span class="keyword">int</span> , <span class="keyword">char</span> ** )</div><div class="line">{</div><div class="line">sqlite3 * db;</div><div class="line"><span class="keyword">int</span> result;</div><div class="line"><span class="keyword">char</span> * errmsg = NULL;</div><div class="line"></div><div class="line">result = sqlite3_open( “c:\\Dcg_database.db”, &db );</div><div class="line"><span class="keyword">if</span>( result != SQLITE_OK )</div><div class="line">{</div><div class="line"><span class="comment">//数据库打开失败</span></div><div class="line"><span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">//数据库操作代码</span></div><div class="line"><span class="comment">//创建一个测试表，表名叫 MyTable_1，有2个字段： ID 和 name。其中ID是一个自动增加的类型，以后insert时可以不去指定这个字段，它会自己从0开始增加</span></div><div class="line">result = sqlite3_exec( db, “create table MyTable_1( ID integer primary key autoincrement, name nvarchar(<span class="number">32</span>) )”, NULL, NULL, errmsg );</div><div class="line"><span class="keyword">if</span>(result != SQLITE_OK )</div><div class="line">{</div><div class="line"><span class="built_in">printf</span>( “创建表失败，错误码:%d，错误原因:%s\n”, result, errmsg );</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">//插入一些记录</span></div><div class="line">result = sqlite3_exec( db, “insert into MyTable_1( name ) values ( ‘走路’ )”, <span class="number">0</span>, <span class="number">0</span>, errmsg );</div><div class="line"><span class="keyword">if</span>(result != SQLITE_OK )</div><div class="line">{</div><div class="line"><span class="built_in">printf</span>( “插入记录失败，错误码:%d，错误原因:%s\n”, result, errmsg );</div><div class="line">}</div><div class="line"></div><div class="line">result = sqlite3_exec( db, “insert into MyTable_1( name ) values ( ‘骑单车’ )”, <span class="number">0</span>, <span class="number">0</span>, errmsg );</div><div class="line"><span class="keyword">if</span>(result != SQLITE_OK )</div><div class="line">{</div><div class="line"><span class="built_in">printf</span>( “插入记录失败，错误码:%d，错误原因:%s\n”, result, errmsg );</div><div class="line">}</div><div class="line"></div><div class="line">result = sqlite3_exec( db, “insert into MyTable_1( name ) values ( ‘坐汽车’ )”, <span class="number">0</span>, <span class="number">0</span>, errmsg );</div><div class="line"><span class="keyword">if</span>(result != SQLITE_OK )</div><div class="line">{</div><div class="line"><span class="built_in">printf</span>( “插入记录失败，错误码:%d，错误原因:%s\n”, result, errmsg );</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">//开始查询数据库</span></div><div class="line">result = sqlite3_exec( db, “select * from MyTable_1”, LoadMyInfo, NULL, errmsg );</div><div class="line"></div><div class="line"><span class="comment">//关闭数据库</span></div><div class="line">sqlite3_close( db );</div><div class="line"><span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">}</div></pre></td></tr></table></figure>

<p>通过上面的例子，应该可以知道如何打开一个数据库，如何做数据库基本操作。<br>有这些知识，基本上可以应付很多数据库操作了。</p>
<h3 id="（3）不使用回调查询数据库">（3）不使用回调查询数据库</h3>
<p>上面介绍的 sqlite3_exec 是使用回调来执行 select 操作。还有一个方法可以直接查询而不需要回调。<br>但是，我个人感觉还是回调好，因为代码可以更加整齐，只不过用回调很麻烦，你得声明一个函数，如果这个函数 是类成员函数，你还不得不把它声明成 static 的<br>（要问为什么？这又是C++基础了。C++成员函数实际上隐藏了一个参数：this，C++调用类的成员函数的时候，隐含把类指针当成函数的第一个参数 传递进去。<br>结果，这造成跟前面说的 sqlite 回调函数的参数不相符。只有当把成员函数声明成 static 时，它才没有多余的隐含的this参数）。<br>虽然回调显得代码整齐，但有时候你还是想要非回调的 select 查询。这可以通过 sqlite3_get_table 函数做到。<br>int sqlite3_get_table(sqlite3<em>, const char </em>sql, char <strong><em>resultp, int </em>nrow, int *ncolumn, char </strong>errmsg );<br>第1个参数不再多说，看前面的例子。<br>第2个参数是 sql 语句，跟 sqlite3_exec 里的 sql 是一样的。是一个很普通的以\0结尾的char *字符串。<br>第3个参数是查询结果，它依然一维数组（不要以为是二维数组，更不要以为是三维数组）。它内存布局是：第一行是字段名称，后面是紧接着是每个字段的值。下面用例子来说事。<br>第4个参数是查询出多少条记录（即查出多少行）。<br>第5个参数是多少个字段（多少列）。<br>第6个参数是错误信息，跟前面一样，这里不多说了。<br>下面给个简单例子:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> main( <span class="keyword">int</span> , <span class="keyword">char</span> ** )</div><div class="line">{</div><div class="line">sqlite3 * db;</div><div class="line"><span class="keyword">int</span> result;</div><div class="line"><span class="keyword">char</span> * errmsg = NULL;</div><div class="line"><span class="keyword">char</span> **dbResult; <span class="comment">//是 char ** 类型，两个*号</span></div><div class="line"><span class="keyword">int</span> nRow, nColumn;</div><div class="line"><span class="keyword">int</span> i , j;</div><div class="line"><span class="keyword">int</span> index;</div><div class="line"></div><div class="line">result = sqlite3_open( “c:\\Dcg_database.db”, &db );</div><div class="line"><span class="keyword">if</span>( result != SQLITE_OK )</div><div class="line">{</div><div class="line"><span class="comment">//数据库打开失败</span></div><div class="line"><span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">//数据库操作代码</span></div><div class="line"><span class="comment">//假设前面已经创建了 MyTable_1 表</span></div><div class="line"><span class="comment">//开始查询，传入的 dbResult 已经是 char **，这里又加了一个 & 取地址符，传递进去的就成了 char ***</span></div><div class="line">result = sqlite3_get_table( db, “select * from MyTable_1”, &dbResult, &nRow, &nColumn, &errmsg );</div><div class="line"><span class="keyword">if</span>( SQLITE_OK == result )</div><div class="line">{</div><div class="line"><span class="comment">//查询成功</span></div><div class="line">index = nColumn; <span class="comment">//前面说过 dbResult 前面第一行数据是字段名称，从 nColumn 索引开始才是真正的数据</span></div><div class="line"><span class="built_in">printf</span>( “查到%d条记录\n”, nRow );</div><div class="line"></div><div class="line"><span class="keyword">for</span>(  i = <span class="number">0</span>; i &lt; nRow ; i++ )</div><div class="line">{</div><div class="line"><span class="built_in">printf</span>( “第 %d 条记录\n”, i+<span class="number">1</span> );</div><div class="line"><span class="keyword">for</span>( j = <span class="number">0</span> ; j &lt; nColumn; j++ )</div><div class="line">{</div><div class="line"><span class="built_in">printf</span>( “字段名:%s  ?&gt; 字段值:%s\n”,  dbResult[j], dbResult [index] );</div><div class="line">++index; <span class="comment">// dbResult 的字段值是连续的，从第0索引到第 nColumn – 1索引都是字段名称，从第 nColumn 索引开始，后面都是字段值，它把一个二维的表（传统的行列表示法）用一个扁平的形式来表示</span></div><div class="line">}</div><div class="line"><span class="built_in">printf</span>( “——-\n” );</div><div class="line">}</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">//到这里，不论数据库查询是否成功，都释放 char** 查询结果，使用 sqlite 提供的功能来释放</span></div><div class="line">sqlite3_free_table( dbResult );</div><div class="line"></div><div class="line"><span class="comment">//关闭数据库</span></div><div class="line">sqlite3_close( db );</div><div class="line"><span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">}</div></pre></td></tr></table></figure>

<p>到这个例子为止，sqlite3 的常用用法都介绍完了。<br>用以上的方法，再配上 sql 语句，完全可以应付绝大多数数据库需求。</p>
]]></content>
    <summary type="html">
    <![CDATA[<h2 id="一、版本">一、版本</h2>
<p>从 www.sqlite.org 网站可下载到最新的 sqlite 代码和编译版本。我写此文章时，最新代码是 3.3.17 版本。<br>很久没有去下载 sqlite 新代码，因此也不知道 sqlite 变化这么大。以前很多文]]>
    </summary>
    
      <category term="基础编程" scheme="http://yoursite.com/categories/%E5%9F%BA%E7%A1%80%E7%BC%96%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[windows����������]]></title>
    <link href="http://yoursite.com/2014/11/05/C%E8%AF%AD%E8%A8%80%E6%93%8D%E4%BD%9CSQLITE3%E6%95%B0%E6%8D%AE%E5%BA%931/"/>
    <id>http://yoursite.com/2014/11/05/C语言操作SQLITE3数据库1/</id>
    <published>2014-11-05T03:31:56.000Z</published>
    <updated>2014-11-05T03:31:57.000Z</updated>
    <content type="html"><![CDATA[<h2 id="һ���汾">һ���汾</h2>
<p>�� www.sqlite.org ��վ�����ص����µ� sqlite �����ͱ����汾����д������ʱ�����´����� 3.3.17 �汾��<br>�ܾ�û��ȥ���� sqlite �´��룬����Ҳ��֪�� sqlite �仯��ô������ǰ�ܶ��ļ�������ȫ���ϲ���һ�� sqlite3.c �ļ���<br>���������ô��ļ�����ͦ�õģ�ʡȥ����һ���ļ���������û����©������Ҳ����һ�����⣺���ļ�̫�󣬿��ӽ�7���д��룬VC�������������������� �ˡ�<br>��������Ҫ�������룬Ҳ�Ͳ���Ҫ���� sqlite3.c �ļ������󲻻��������ǣ�������Ҫдͨ���޸� sqlite �������ɼ��ܹ��ܣ���ʱ���ͱȽ�ʹ���ˡ�</p>
<h2 id="������������">������������</h2>
<p>����������˵�ˣ��� VC ���½� dos ����̨�հ׹��̣��� sqlite3.c �� sqlite3.h ���ӵ����̣����½�һ�� main.cpp �ļ���������д:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">extern</span> ��C��</div><div class="line">{</div><div class="line"><span class="preprocessor">#include ��./sqlite3.h��</span></div><div class="line">};</div><div class="line"><span class="keyword">int</span> main( <span class="keyword">int</span> , <span class="keyword">char</span>** )</div><div class="line">{</div><div class="line"><span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">}</div></pre></td></tr></table></figure>

<p>ΪʲôҪ extern ��C�� ���������������⣬�Ҳ���˵̫�࣬����C++�Ļ�����Ҫ�� C++ ��ʹ��һ�� C �Ĵ��룬����Ҫ�� extern ��C�� ��������<br>C++�� C��Ȼ�﷨�����ص�������������������ͬ�Ķ������ڴ����Ĳ�������ȫ��ͬ�ģ���C++�������ﲻ��extern ��C������C���룬�ᵼ�±�������֪��������Ϊ C ���������ڴ沼�֡�<br>������ sqlite3.c ���˼��Ѿ������δ��붼 extern ��C�� �������ˣ�����������һ�� .c �ļ����Ծ�������һ�Σ�Ҳûʲô���á�<br>�������̾��������������ˡ����룬����ͨ����������һ�ѵ� warning�����Բ�������</p>
<h2 id="����SQLITE��������">����SQLITE��������</h2>
<p>sqlite�ṩ����һЩC�����ӿڣ�����������Щ�����������ݿ⡣ͨ��ʹ����Щ�ӿڣ�����һЩ��׼ sql ���䣨�� char * ���ͣ��� sqlite ������sqlite �ͻ�Ϊ���������ݿ⡣<br>sqlite ��MS��accessһ�����ļ������ݿ⣬����˵��һ�����ݿ�����һ���ļ��������ݿ������Խ����ܶ��ı����Խ����������������ȵȣ����ǣ���ʵ���ϵõ��ľ���һ���ļ���<br>���������ļ��ͱ������������ݿ⡣sqlite ����Ҫ�κ����ݿ����棬����ζ����������Ҫ sqlite ������һЩ�û����ݣ�����������Ҫ��װ���ݿ⡣<br>���濪ʼ�������ݿ�����������</p>
<h3 id="1_�������̣�1���ؼ����ݽṹ">1 �������̣�1���ؼ����ݽṹ</h3>
<p>sqlite ����õ�����sqlite3 <em> ���͡������ݿ��򿪿�ʼ��sqlite��ҪΪ��������׼�����ڴ棬ֱ�����ݿ��رգ��������̶���Ҫ�õ���������.<br>�����ݿ�����ʱ��ʼ���������͵ı����ʹ�������Ҫ���������ݿ⡣��������ϸ���ܡ�<br>��2���������ݿ�<br>int sqlite3_open( �ļ���, sqlite3 <em>* );<br>������������ʼ���ݿ�������<br>��Ҫ��������������һ�����ݿ��ļ��������磺c:\DongChunGuang_Database.db��<br>�ļ�������Ҫһ�����ڣ��������ļ������ڣ�sqlite ���Զ������������������ڣ��ͳ��԰��������ݿ��ļ����򿪡�<br>sqlite3 </em></em> ������ǰ���ᵽ�Ĺؼ����ݽṹ�������ṹ�ײ�ϸ�����Σ��㲻Ҫ������<br>��������ֵ��ʾ�����Ƿ���ȷ��������SQLITE_OK ����ʾ�������������صķ���ֵsqlite������һЩ�ꡣ������Щ���ĺ������Բο� sqlite3.h �ļ���<br>��������ϸ���壨˳��˵һ�£�sqlite3 �Ĵ���ע�����Գ��Ƿǳ��ߵģ�ʵ����Ҳ��ȷ�ܸߡ�ֻҪ���ῴӢ�ģ�sqlite ��������ѧ�����ٶ��󣩡�<br>�������ܹر����ݿ������ٸ�һ�βο����롣<br>��3���ر����ݿ�</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> sqlite3_close(sqlite3 *);</div><div class="line">ǰ�������� sqlite3_open ������һ�����ݿ⣬��βʱ��Ҫ���������������ر����ݿ⡣</div><div class="line">�������μ򵥵Ĵ��룺</div><div class="line"><span class="keyword">extern</span> ��C��</div><div class="line">{</div><div class="line"><span class="preprocessor">#include ��./sqlite3.h��</span></div><div class="line">};</div><div class="line"><span class="keyword">int</span> main( <span class="keyword">int</span> , <span class="keyword">char</span>** )</div><div class="line">{</div><div class="line">sqlite3 * db = NULL; <span class="comment">//����sqlite�ؼ��ṹָ��</span></div><div class="line"><span class="keyword">int</span> result;</div><div class="line"></div><div class="line"><span class="comment">//�������ݿ�</span></div><div class="line"><span class="comment">//��Ҫ���� db ����ָ����ָ�룬��Ϊ sqlite3_open ����ҪΪ����ָ�������ڴ棬��Ҫ��dbָ��ָ�������ڴ���</span></div><div class="line">result = sqlite3_open( ��c:\\Dcg_database.db��, &db );</div><div class="line"><span class="keyword">if</span>( result != SQLITE_OK )</div><div class="line">{</div><div class="line"><span class="comment">//���ݿ�����ʧ��</span></div><div class="line"><span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line">}</div><div class="line"><span class="comment">//���ݿ���������</span></div><div class="line"><span class="comment">//��</span></div><div class="line"></div><div class="line"><span class="comment">//���ݿ��򿪳ɹ�</span></div><div class="line"><span class="comment">//�ر����ݿ�</span></div><div class="line">sqlite3_close( db );</div><div class="line"><span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">}</div></pre></td></tr></table></figure>

<p>������һ�����ݿ��������̡�</p>
<h3 id="2_SQL��������">2 SQL��������</h3>
<p>���ڽ���������sqlite ִ�б�׼ sql �﷨��</p>
<p>��1��ִ��sql����</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> sqlite3_exec(sqlite3*, <span class="keyword">const</span> <span class="keyword">char</span> *sql, sqlite3_callback, <span class="keyword">void</span> *,  <span class="keyword">char</span> **errmsg );</div><div class="line">������ִ��һ�� sql �����ĺ�����</div><div class="line">��<span class="number">1</span>����������˵�ˣ���ǰ��open�����õ���ָ�롣˵���ǹؼ����ݽṹ��</div><div class="line">��<span class="number">2</span>������<span class="keyword">const</span> <span class="keyword">char</span> *sql ��һ�� sql ���䣬��\<span class="number">0</span>��β��</div><div class="line">��<span class="number">3</span>������sqlite3_callback �ǻص󣬵���������ִ��֮����sqlite3��ȥ�������ṩ��������������ʲô�ǻص��������Լ��ұ�������ѧϰ��</div><div class="line">��<span class="number">4</span>������<span class="keyword">void</span> * �������ṩ��ָ�룬�����Դ����κ�һ��ָ����������������������ջᴫ���ص��������棬��������Ҫ����ָ�����ص�������������NULL��</div><div class="line">���������ٿ��ص�������д�����Լ�����������ʹ�á�</div><div class="line">�� <span class="number">5</span>������<span class="keyword">char</span> ** errmsg �Ǵ�����Ϣ��ע����ָ����ָ�롣</div><div class="line">sqlite3�����кܶ��̶��Ĵ�����Ϣ��ִ�� sqlite3_exec ֮����ִ��ʧ��ʱ���Բ�������ָ�루ֱ�� <span class="built_in">printf</span>(��%s\n��,errmsg)���õ�һ���ַ�����Ϣ���⴮��Ϣ����������ʲô�ط���</div><div class="line">sqlite3_exec����ͨ���޸��㴫����ָ����ָ �룬�����ṩ��ָ��ָ��������ʾ��Ϣ������sqlite3_exec���������Ϳ���ͨ������ <span class="keyword">char</span>*�õ�����������ʾ��</div><div class="line">˵����ͨ����sqlite3_callback ���������� <span class="keyword">void</span> * ������λ�ö������� NULL��</div><div class="line">��NULL��ʾ�㲻��Ҫ�ص󡣱������� insert �������� <span class="keyword">delete</span> ���󣬾�û�б�Ҫʹ�ûص󡣶������� select ʱ����Ҫʹ�ûص�����Ϊ sqlite3 �����ݲ���������ͨ���ص�������������ʲô���ݡ�</div></pre></td></tr></table></figure>

<p>��2��exec �Ļص�</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">int</span> (*sqlite3_callback)(<span class="keyword">void</span>*,<span class="keyword">int</span>,<span class="keyword">char</span>**, <span class="keyword">char</span>**);</div><div class="line">���Ļص��������붨���������������������͡����������򵥵����ӣ�</div><div class="line"><span class="comment">//sqlite3�Ļص�����</span></div><div class="line"><span class="comment">// sqlite ÿ�鵽һ����¼���͵���һ�������ص�</span></div><div class="line"><span class="keyword">int</span> LoadMyInfo( <span class="keyword">void</span> * para, <span class="keyword">int</span> n_column, <span class="keyword">char</span> ** column_value, <span class="keyword">char</span> ** column_name )</div><div class="line">{</div><div class="line"><span class="comment">//para������ sqlite3_exec �ﴫ���� void * ����</span></div><div class="line"><span class="comment">//ͨ��para�����������Դ���һЩ������ָ�루������ָ�롢�ṹָ�룩��Ȼ����������ǿ��ת���ɶ�Ӧ�����ͣ���������void*���ͣ�����ǿ��ת�����������Ͳſ��ã���Ȼ��������Щ����</span></div><div class="line"><span class="comment">//n_column����һ����¼�ж��ٸ��ֶ� (��������¼�ж�����)</span></div><div class="line"><span class="comment">// char ** column_value �Ǹ��ؼ�ֵ�������������ݶ������������ʵ�����Ǹ�1ά���飨��Ҫ��Ϊ��2ά���飩��ÿһ��Ԫ�ض���һ�� char * ֵ����һ���ֶ����ݣ����ַ�������ʾ����\0��β��</span></div><div class="line"></div><div class="line"><span class="comment">//char ** column_name �� column_value�Ƕ�Ӧ�ģ���ʾ�����ֶε��ֶ�����</span></div><div class="line"></div><div class="line"><span class="comment">//����Ҳ�ʹ�� para �������������Ĵ���.</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> i;</div><div class="line"></div><div class="line"><span class="built_in">printf</span>( ����¼���� %d ���ֶ�\n��, n_column );</div><div class="line"><span class="keyword">for</span>( i = <span class="number">0</span> ; i &lt; n_column; i ++ )</div><div class="line">{</div><div class="line"><span class="built_in">printf</span>( ���ֶ���:%s  ?&gt; �ֶ�ֵ:%s\n��,  column_name[i], column_value[i] );</div><div class="line">}</div><div class="line"><span class="built_in">printf</span>( ��������������\n�� );</div><div class="line"><span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">int</span> main( <span class="keyword">int</span> , <span class="keyword">char</span> ** )</div><div class="line">{</div><div class="line">sqlite3 * db;</div><div class="line"><span class="keyword">int</span> result;</div><div class="line"><span class="keyword">char</span> * errmsg = NULL;</div><div class="line"></div><div class="line">result = sqlite3_open( ��c:\\Dcg_database.db��, &db );</div><div class="line"><span class="keyword">if</span>( result != SQLITE_OK )</div><div class="line">{</div><div class="line"><span class="comment">//���ݿ�����ʧ��</span></div><div class="line"><span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">//���ݿ���������</span></div><div class="line"><span class="comment">//����һ�����Ա������� MyTable_1����2���ֶΣ� ID �� name������ID��һ���Զ����ӵ����ͣ��Ժ�insertʱ���Բ�ȥָ�������ֶΣ������Լ���0��ʼ����</span></div><div class="line">result = sqlite3_exec( db, ��create table MyTable_1( ID integer primary key autoincrement, name nvarchar(<span class="number">32</span>) )��, NULL, NULL, errmsg );</div><div class="line"><span class="keyword">if</span>(result != SQLITE_OK )</div><div class="line">{</div><div class="line"><span class="built_in">printf</span>( ��������ʧ�ܣ�������:%d������ԭ��:%s\n��, result, errmsg );</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">//����һЩ��¼</span></div><div class="line">result = sqlite3_exec( db, ��insert into MyTable_1( name ) values ( ����·�� )��, <span class="number">0</span>, <span class="number">0</span>, errmsg );</div><div class="line"><span class="keyword">if</span>(result != SQLITE_OK )</div><div class="line">{</div><div class="line"><span class="built_in">printf</span>( ��������¼ʧ�ܣ�������:%d������ԭ��:%s\n��, result, errmsg );</div><div class="line">}</div><div class="line"></div><div class="line">result = sqlite3_exec( db, ��insert into MyTable_1( name ) values ( ���ﵥ���� )��, <span class="number">0</span>, <span class="number">0</span>, errmsg );</div><div class="line"><span class="keyword">if</span>(result != SQLITE_OK )</div><div class="line">{</div><div class="line"><span class="built_in">printf</span>( ��������¼ʧ�ܣ�������:%d������ԭ��:%s\n��, result, errmsg );</div><div class="line">}</div><div class="line"></div><div class="line">result = sqlite3_exec( db, ��insert into MyTable_1( name ) values ( ���������� )��, <span class="number">0</span>, <span class="number">0</span>, errmsg );</div><div class="line"><span class="keyword">if</span>(result != SQLITE_OK )</div><div class="line">{</div><div class="line"><span class="built_in">printf</span>( ��������¼ʧ�ܣ�������:%d������ԭ��:%s\n��, result, errmsg );</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">//��ʼ��ѯ���ݿ�</span></div><div class="line">result = sqlite3_exec( db, ��select * from MyTable_1��, LoadMyInfo, NULL, errmsg );</div><div class="line"></div><div class="line"><span class="comment">//�ر����ݿ�</span></div><div class="line">sqlite3_close( db );</div><div class="line"><span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">}</div></pre></td></tr></table></figure>

<p>ͨ�����������ӣ�Ӧ�ÿ���֪�����δ���һ�����ݿ⣬���������ݿ�����������<br>����Щ֪ʶ�������Ͽ���Ӧ���ܶ����ݿ������ˡ�</p>
<h3 id="��3����ʹ�ûص���ѯ���ݿ�">��3����ʹ�ûص���ѯ���ݿ�</h3>
<p>�������ܵ� sqlite3_exec ��ʹ�ûص���ִ�� select ���󡣻���һ�򷽷�����ֱ�Ӳ�ѯ������Ҫ�ص���<br>���ǣ��Ҹ��˸о����ǻص��ã���Ϊ�������Ը������룬ֻ�����ûص����鷳����������һ�������������������� ������Ա�������㻹���ò����������� static ��<br>��Ҫ��Ϊʲô��������C++�����ˡ�C++��Ա����ʵ����������һ��������this��C++�������ĳ�Ա������ʱ������������ָ�뵱�ɺ����ĵ�һ������ ���ݽ�ȥ��<br>�����������ɸ�ǰ��˵�� sqlite �ص������Ĳ�����������ֻ�е��ѳ�Ա���������� static ʱ������û�ж�����������this��������<br>��Ȼ�ص��Եô������룬����ʱ���㻹����Ҫ�ǻص��� select ��ѯ��������ͨ�� sqlite3_get_table �����򵽡�<br>int sqlite3_get_table(sqlite3<em>, const char </em>sql, char <strong><em>resultp, int </em>nrow, int *ncolumn, char </strong>errmsg );<br>��1���������ٶ�˵����ǰ�������ӡ�<br>��2�������� sql ���䣬�� sqlite3_exec ���� sql ��һ���ġ���һ������ͨ����\0��β��char *�ַ�����<br>��3�������ǲ�ѯ����������Ȼһά���飨��Ҫ��Ϊ�Ƕ�ά���飬����Ҫ��Ϊ����ά���飩�����ڴ沼���ǣ���һ�����ֶ����ƣ������ǽ�������ÿ���ֶε�ֵ��������������˵�¡�<br>��4�������ǲ�ѯ����������¼�������������У���<br>��5�������Ƕ��ٸ��ֶΣ������У���<br>��6�������Ǵ�����Ϣ����ǰ��һ�������ﲻ��˵�ˡ�<br>����������������:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> main( <span class="keyword">int</span> , <span class="keyword">char</span> ** )</div><div class="line">{</div><div class="line">sqlite3 * db;</div><div class="line"><span class="keyword">int</span> result;</div><div class="line"><span class="keyword">char</span> * errmsg = NULL;</div><div class="line"><span class="keyword">char</span> **dbResult; <span class="comment">//�� char ** ���ͣ�����*��</span></div><div class="line"><span class="keyword">int</span> nRow, nColumn;</div><div class="line"><span class="keyword">int</span> i , j;</div><div class="line"><span class="keyword">int</span> index;</div><div class="line"></div><div class="line">result = sqlite3_open( ��c:\\Dcg_database.db��, &db );</div><div class="line"><span class="keyword">if</span>( result != SQLITE_OK )</div><div class="line">{</div><div class="line"><span class="comment">//���ݿ�����ʧ��</span></div><div class="line"><span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">//���ݿ���������</span></div><div class="line"><span class="comment">//����ǰ���Ѿ������� MyTable_1 ��</span></div><div class="line"><span class="comment">//��ʼ��ѯ�������� dbResult �Ѿ��� char **�������ּ���һ�� & ȡ��ַ�������ݽ�ȥ�ľͳ��� char ***</span></div><div class="line">result = sqlite3_get_table( db, ��select * from MyTable_1��, &dbResult, &nRow, &nColumn, &errmsg );</div><div class="line"><span class="keyword">if</span>( SQLITE_OK == result )</div><div class="line">{</div><div class="line"><span class="comment">//��ѯ�ɹ�</span></div><div class="line">index = nColumn; <span class="comment">//ǰ��˵�� dbResult ǰ����һ���������ֶ����ƣ��� nColumn ������ʼ��������������</span></div><div class="line"><span class="built_in">printf</span>( ���鵽%d����¼\n��, nRow );</div><div class="line"></div><div class="line"><span class="keyword">for</span>(  i = <span class="number">0</span>; i &lt; nRow ; i++ )</div><div class="line">{</div><div class="line"><span class="built_in">printf</span>( ���� %d ����¼\n��, i+<span class="number">1</span> );</div><div class="line"><span class="keyword">for</span>( j = <span class="number">0</span> ; j &lt; nColumn; j++ )</div><div class="line">{</div><div class="line"><span class="built_in">printf</span>( ���ֶ���:%s  ?&gt; �ֶ�ֵ:%s\n��,  dbResult[j], dbResult [index] );</div><div class="line">++index; <span class="comment">// dbResult ���ֶ�ֵ�������ģ��ӵ�0�������� nColumn �C 1���������ֶ����ƣ��ӵ� nColumn ������ʼ�����涼���ֶ�ֵ������һ����ά�ı���ͳ�����б�ʾ������һ����ƽ����ʽ����ʾ</span></div><div class="line">}</div><div class="line"><span class="built_in">printf</span>( ������-\n�� );</div><div class="line">}</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">//������������ݿ���ѯ�Ƿ��ɹ������ͷ� char** ��ѯ������ʹ�� sqlite �ṩ�Ĺ������ͷ�</span></div><div class="line">sqlite3_free_table( dbResult );</div><div class="line"></div><div class="line"><span class="comment">//�ر����ݿ�</span></div><div class="line">sqlite3_close( db );</div><div class="line"><span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">}</div></pre></td></tr></table></figure>

<p>����������Ϊֹ��sqlite3 �ĳ����÷����������ˡ�<br>�����ϵķ����������� sql ���䣬��ȫ����Ӧ�������������ݿ�������</p>
]]></content>
    <summary type="html">
    <![CDATA[<h2 id="һ���汾">һ���汾</h2>
<p>�� www.sqlite.org ��վ�����ص����µ� sqlite �����ͱ����汾����д������ʱ�����´����� 3.3.17 �汾��<br>�ܾ�û��ȥ���� sqlite �]]>
    </summary>
    
      <category term="��������" scheme="http://yoursite.com/categories/%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[windows����������]]></title>
    <link href="http://yoursite.com/2014/11/05/C%E8%AF%AD%E8%A8%80%E6%93%8D%E4%BD%9CSQLITE3%E6%95%B0%E6%8D%AE%E5%BA%931/"/>
    <id>http://yoursite.com/2014/11/05/C语言操作SQLITE3数据库1/</id>
    <published>2014-11-05T03:31:56.000Z</published>
    <updated>2014-11-05T03:31:57.000Z</updated>
    <content type="html"><![CDATA[<h2 id="һ���汾">һ���汾</h2>
<p>�� www.sqlite.org ��վ�����ص����µ� sqlite �����ͱ����汾����д������ʱ�����´����� 3.3.17 �汾��<br>�ܾ�û��ȥ���� sqlite �´��룬����Ҳ��֪�� sqlite �仯��ô������ǰ�ܶ��ļ�������ȫ���ϲ���һ�� sqlite3.c �ļ���<br>���������ô��ļ�����ͦ�õģ�ʡȥ����һ���ļ���������û����©������Ҳ����һ�����⣺���ļ�̫�󣬿��ӽ�7���д��룬VC�������������������� �ˡ�<br>��������Ҫ�������룬Ҳ�Ͳ���Ҫ���� sqlite3.c �ļ������󲻻��������ǣ�������Ҫдͨ���޸� sqlite �������ɼ��ܹ��ܣ���ʱ���ͱȽ�ʹ���ˡ�</p>
<h2 id="������������">������������</h2>
<p>����������˵�ˣ��� VC ���½� dos ����̨�հ׹��̣��� sqlite3.c �� sqlite3.h ���ӵ����̣����½�һ�� main.cpp �ļ���������д:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">extern</span> ��C��</div><div class="line">{</div><div class="line"><span class="preprocessor">#include ��./sqlite3.h��</span></div><div class="line">};</div><div class="line"><span class="keyword">int</span> main( <span class="keyword">int</span> , <span class="keyword">char</span>** )</div><div class="line">{</div><div class="line"><span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">}</div></pre></td></tr></table></figure>

<p>ΪʲôҪ extern ��C�� ���������������⣬�Ҳ���˵̫�࣬����C++�Ļ�����Ҫ�� C++ ��ʹ��һ�� C �Ĵ��룬����Ҫ�� extern ��C�� ��������<br>C++�� C��Ȼ�﷨�����ص�������������������ͬ�Ķ������ڴ����Ĳ�������ȫ��ͬ�ģ���C++�������ﲻ��extern ��C������C���룬�ᵼ�±�������֪��������Ϊ C ���������ڴ沼�֡�<br>������ sqlite3.c ���˼��Ѿ������δ��붼 extern ��C�� �������ˣ�����������һ�� .c �ļ����Ծ�������һ�Σ�Ҳûʲô���á�<br>�������̾��������������ˡ����룬����ͨ����������һ�ѵ� warning�����Բ�������</p>
<h2 id="����SQLITE��������">����SQLITE��������</h2>
<p>sqlite�ṩ����һЩC�����ӿڣ�����������Щ�����������ݿ⡣ͨ��ʹ����Щ�ӿڣ�����һЩ��׼ sql ���䣨�� char * ���ͣ��� sqlite ������sqlite �ͻ�Ϊ���������ݿ⡣<br>sqlite ��MS��accessһ�����ļ������ݿ⣬����˵��һ�����ݿ�����һ���ļ��������ݿ������Խ����ܶ��ı����Խ����������������ȵȣ����ǣ���ʵ���ϵõ��ľ���һ���ļ���<br>���������ļ��ͱ������������ݿ⡣sqlite ����Ҫ�κ����ݿ����棬����ζ����������Ҫ sqlite ������һЩ�û����ݣ�����������Ҫ��װ���ݿ⡣<br>���濪ʼ�������ݿ�����������</p>
<h3 id="1_�������̣�1���ؼ����ݽṹ">1 �������̣�1���ؼ����ݽṹ</h3>
<p>sqlite ����õ�����sqlite3 <em> ���͡������ݿ��򿪿�ʼ��sqlite��ҪΪ��������׼�����ڴ棬ֱ�����ݿ��رգ��������̶���Ҫ�õ���������.<br>�����ݿ�����ʱ��ʼ���������͵ı����ʹ�������Ҫ���������ݿ⡣��������ϸ���ܡ�<br>��2���������ݿ�<br>int sqlite3_open( �ļ���, sqlite3 <em>* );<br>������������ʼ���ݿ�������<br>��Ҫ��������������һ�����ݿ��ļ��������磺c:\DongChunGuang_Database.db��<br>�ļ�������Ҫһ�����ڣ��������ļ������ڣ�sqlite ���Զ������������������ڣ��ͳ��԰��������ݿ��ļ����򿪡�<br>sqlite3 </em></em> ������ǰ���ᵽ�Ĺؼ����ݽṹ�������ṹ�ײ�ϸ�����Σ��㲻Ҫ������<br>��������ֵ��ʾ�����Ƿ���ȷ��������SQLITE_OK ����ʾ�������������صķ���ֵsqlite������һЩ�ꡣ������Щ���ĺ������Բο� sqlite3.h �ļ���<br>��������ϸ���壨˳��˵һ�£�sqlite3 �Ĵ���ע�����Գ��Ƿǳ��ߵģ�ʵ����Ҳ��ȷ�ܸߡ�ֻҪ���ῴӢ�ģ�sqlite ��������ѧ�����ٶ��󣩡�<br>�������ܹر����ݿ������ٸ�һ�βο����롣<br>��3���ر����ݿ�</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> sqlite3_close(sqlite3 *);</div><div class="line">ǰ�������� sqlite3_open ������һ�����ݿ⣬��βʱ��Ҫ���������������ر����ݿ⡣</div><div class="line">�������μ򵥵Ĵ��룺</div><div class="line"><span class="keyword">extern</span> ��C��</div><div class="line">{</div><div class="line"><span class="preprocessor">#include ��./sqlite3.h��</span></div><div class="line">};</div><div class="line"><span class="keyword">int</span> main( <span class="keyword">int</span> , <span class="keyword">char</span>** )</div><div class="line">{</div><div class="line">sqlite3 * db = NULL; <span class="comment">//����sqlite�ؼ��ṹָ��</span></div><div class="line"><span class="keyword">int</span> result;</div><div class="line"></div><div class="line"><span class="comment">//�������ݿ�</span></div><div class="line"><span class="comment">//��Ҫ���� db ����ָ����ָ�룬��Ϊ sqlite3_open ����ҪΪ����ָ�������ڴ棬��Ҫ��dbָ��ָ�������ڴ���</span></div><div class="line">result = sqlite3_open( ��c:\\Dcg_database.db��, &db );</div><div class="line"><span class="keyword">if</span>( result != SQLITE_OK )</div><div class="line">{</div><div class="line"><span class="comment">//���ݿ�����ʧ��</span></div><div class="line"><span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line">}</div><div class="line"><span class="comment">//���ݿ���������</span></div><div class="line"><span class="comment">//��</span></div><div class="line"></div><div class="line"><span class="comment">//���ݿ��򿪳ɹ�</span></div><div class="line"><span class="comment">//�ر����ݿ�</span></div><div class="line">sqlite3_close( db );</div><div class="line"><span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">}</div></pre></td></tr></table></figure>

<p>������һ�����ݿ��������̡�</p>
<h3 id="2_SQL��������">2 SQL��������</h3>
<p>���ڽ���������sqlite ִ�б�׼ sql �﷨��</p>
<p>��1��ִ��sql����</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> sqlite3_exec(sqlite3*, <span class="keyword">const</span> <span class="keyword">char</span> *sql, sqlite3_callback, <span class="keyword">void</span> *,  <span class="keyword">char</span> **errmsg );</div><div class="line">������ִ��һ�� sql �����ĺ�����</div><div class="line">��<span class="number">1</span>����������˵�ˣ���ǰ��open�����õ���ָ�롣˵���ǹؼ����ݽṹ��</div><div class="line">��<span class="number">2</span>������<span class="keyword">const</span> <span class="keyword">char</span> *sql ��һ�� sql ���䣬��\<span class="number">0</span>��β��</div><div class="line">��<span class="number">3</span>������sqlite3_callback �ǻص󣬵���������ִ��֮����sqlite3��ȥ�������ṩ��������������ʲô�ǻص��������Լ��ұ�������ѧϰ��</div><div class="line">��<span class="number">4</span>������<span class="keyword">void</span> * �������ṩ��ָ�룬�����Դ����κ�һ��ָ����������������������ջᴫ���ص��������棬��������Ҫ����ָ�����ص�������������NULL��</div><div class="line">���������ٿ��ص�������д�����Լ�����������ʹ�á�</div><div class="line">�� <span class="number">5</span>������<span class="keyword">char</span> ** errmsg �Ǵ�����Ϣ��ע����ָ����ָ�롣</div><div class="line">sqlite3�����кܶ��̶��Ĵ�����Ϣ��ִ�� sqlite3_exec ֮����ִ��ʧ��ʱ���Բ�������ָ�루ֱ�� <span class="built_in">printf</span>(��%s\n��,errmsg)���õ�һ���ַ�����Ϣ���⴮��Ϣ����������ʲô�ط���</div><div class="line">sqlite3_exec����ͨ���޸��㴫����ָ����ָ �룬�����ṩ��ָ��ָ��������ʾ��Ϣ������sqlite3_exec���������Ϳ���ͨ������ <span class="keyword">char</span>*�õ�����������ʾ��</div><div class="line">˵����ͨ����sqlite3_callback ���������� <span class="keyword">void</span> * ������λ�ö������� NULL��</div><div class="line">��NULL��ʾ�㲻��Ҫ�ص󡣱������� insert �������� <span class="keyword">delete</span> ���󣬾�û�б�Ҫʹ�ûص󡣶������� select ʱ����Ҫʹ�ûص�����Ϊ sqlite3 �����ݲ���������ͨ���ص�������������ʲô���ݡ�</div></pre></td></tr></table></figure>

<p>��2��exec �Ļص�</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">int</span> (*sqlite3_callback)(<span class="keyword">void</span>*,<span class="keyword">int</span>,<span class="keyword">char</span>**, <span class="keyword">char</span>**);</div><div class="line">���Ļص��������붨���������������������͡����������򵥵����ӣ�</div><div class="line"><span class="comment">//sqlite3�Ļص�����</span></div><div class="line"><span class="comment">// sqlite ÿ�鵽һ����¼���͵���һ�������ص�</span></div><div class="line"><span class="keyword">int</span> LoadMyInfo( <span class="keyword">void</span> * para, <span class="keyword">int</span> n_column, <span class="keyword">char</span> ** column_value, <span class="keyword">char</span> ** column_name )</div><div class="line">{</div><div class="line"><span class="comment">//para������ sqlite3_exec �ﴫ���� void * ����</span></div><div class="line"><span class="comment">//ͨ��para�����������Դ���һЩ������ָ�루������ָ�롢�ṹָ�룩��Ȼ����������ǿ��ת���ɶ�Ӧ�����ͣ���������void*���ͣ�����ǿ��ת�����������Ͳſ��ã���Ȼ��������Щ����</span></div><div class="line"><span class="comment">//n_column����һ����¼�ж��ٸ��ֶ� (��������¼�ж�����)</span></div><div class="line"><span class="comment">// char ** column_value �Ǹ��ؼ�ֵ�������������ݶ������������ʵ�����Ǹ�1ά���飨��Ҫ��Ϊ��2ά���飩��ÿһ��Ԫ�ض���һ�� char * ֵ����һ���ֶ����ݣ����ַ�������ʾ����\0��β��</span></div><div class="line"></div><div class="line"><span class="comment">//char ** column_name �� column_value�Ƕ�Ӧ�ģ���ʾ�����ֶε��ֶ�����</span></div><div class="line"></div><div class="line"><span class="comment">//����Ҳ�ʹ�� para �������������Ĵ���.</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> i;</div><div class="line"></div><div class="line"><span class="built_in">printf</span>( ����¼���� %d ���ֶ�\n��, n_column );</div><div class="line"><span class="keyword">for</span>( i = <span class="number">0</span> ; i &lt; n_column; i ++ )</div><div class="line">{</div><div class="line"><span class="built_in">printf</span>( ���ֶ���:%s  ?&gt; �ֶ�ֵ:%s\n��,  column_name[i], column_value[i] );</div><div class="line">}</div><div class="line"><span class="built_in">printf</span>( ��������������\n�� );</div><div class="line"><span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">int</span> main( <span class="keyword">int</span> , <span class="keyword">char</span> ** )</div><div class="line">{</div><div class="line">sqlite3 * db;</div><div class="line"><span class="keyword">int</span> result;</div><div class="line"><span class="keyword">char</span> * errmsg = NULL;</div><div class="line"></div><div class="line">result = sqlite3_open( ��c:\\Dcg_database.db��, &db );</div><div class="line"><span class="keyword">if</span>( result != SQLITE_OK )</div><div class="line">{</div><div class="line"><span class="comment">//���ݿ�����ʧ��</span></div><div class="line"><span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">//���ݿ���������</span></div><div class="line"><span class="comment">//����һ�����Ա������� MyTable_1����2���ֶΣ� ID �� name������ID��һ���Զ����ӵ����ͣ��Ժ�insertʱ���Բ�ȥָ�������ֶΣ������Լ���0��ʼ����</span></div><div class="line">result = sqlite3_exec( db, ��create table MyTable_1( ID integer primary key autoincrement, name nvarchar(<span class="number">32</span>) )��, NULL, NULL, errmsg );</div><div class="line"><span class="keyword">if</span>(result != SQLITE_OK )</div><div class="line">{</div><div class="line"><span class="built_in">printf</span>( ��������ʧ�ܣ�������:%d������ԭ��:%s\n��, result, errmsg );</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">//����һЩ��¼</span></div><div class="line">result = sqlite3_exec( db, ��insert into MyTable_1( name ) values ( ����·�� )��, <span class="number">0</span>, <span class="number">0</span>, errmsg );</div><div class="line"><span class="keyword">if</span>(result != SQLITE_OK )</div><div class="line">{</div><div class="line"><span class="built_in">printf</span>( ��������¼ʧ�ܣ�������:%d������ԭ��:%s\n��, result, errmsg );</div><div class="line">}</div><div class="line"></div><div class="line">result = sqlite3_exec( db, ��insert into MyTable_1( name ) values ( ���ﵥ���� )��, <span class="number">0</span>, <span class="number">0</span>, errmsg );</div><div class="line"><span class="keyword">if</span>(result != SQLITE_OK )</div><div class="line">{</div><div class="line"><span class="built_in">printf</span>( ��������¼ʧ�ܣ�������:%d������ԭ��:%s\n��, result, errmsg );</div><div class="line">}</div><div class="line"></div><div class="line">result = sqlite3_exec( db, ��insert into MyTable_1( name ) values ( ���������� )��, <span class="number">0</span>, <span class="number">0</span>, errmsg );</div><div class="line"><span class="keyword">if</span>(result != SQLITE_OK )</div><div class="line">{</div><div class="line"><span class="built_in">printf</span>( ��������¼ʧ�ܣ�������:%d������ԭ��:%s\n��, result, errmsg );</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">//��ʼ��ѯ���ݿ�</span></div><div class="line">result = sqlite3_exec( db, ��select * from MyTable_1��, LoadMyInfo, NULL, errmsg );</div><div class="line"></div><div class="line"><span class="comment">//�ر����ݿ�</span></div><div class="line">sqlite3_close( db );</div><div class="line"><span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">}</div></pre></td></tr></table></figure>

<p>ͨ�����������ӣ�Ӧ�ÿ���֪�����δ���һ�����ݿ⣬���������ݿ�����������<br>����Щ֪ʶ�������Ͽ���Ӧ���ܶ����ݿ������ˡ�</p>
<h3 id="��3����ʹ�ûص���ѯ���ݿ�">��3����ʹ�ûص���ѯ���ݿ�</h3>
<p>�������ܵ� sqlite3_exec ��ʹ�ûص���ִ�� select ���󡣻���һ�򷽷�����ֱ�Ӳ�ѯ������Ҫ�ص���<br>���ǣ��Ҹ��˸о����ǻص��ã���Ϊ�������Ը������룬ֻ�����ûص����鷳����������һ�������������������� ������Ա�������㻹���ò����������� static ��<br>��Ҫ��Ϊʲô��������C++�����ˡ�C++��Ա����ʵ����������һ��������this��C++�������ĳ�Ա������ʱ������������ָ�뵱�ɺ����ĵ�һ������ ���ݽ�ȥ��<br>�����������ɸ�ǰ��˵�� sqlite �ص������Ĳ�����������ֻ�е��ѳ�Ա���������� static ʱ������û�ж�����������this��������<br>��Ȼ�ص��Եô������룬����ʱ���㻹����Ҫ�ǻص��� select ��ѯ��������ͨ�� sqlite3_get_table �����򵽡�<br>int sqlite3_get_table(sqlite3<em>, const char </em>sql, char <strong><em>resultp, int </em>nrow, int *ncolumn, char </strong>errmsg );<br>��1���������ٶ�˵����ǰ�������ӡ�<br>��2�������� sql ���䣬�� sqlite3_exec ���� sql ��һ���ġ���һ������ͨ����\0��β��char *�ַ�����<br>��3�������ǲ�ѯ����������Ȼһά���飨��Ҫ��Ϊ�Ƕ�ά���飬����Ҫ��Ϊ����ά���飩�����ڴ沼���ǣ���һ�����ֶ����ƣ������ǽ�������ÿ���ֶε�ֵ��������������˵�¡�<br>��4�������ǲ�ѯ����������¼�������������У���<br>��5�������Ƕ��ٸ��ֶΣ������У���<br>��6�������Ǵ�����Ϣ����ǰ��һ�������ﲻ��˵�ˡ�<br>����������������:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> main( <span class="keyword">int</span> , <span class="keyword">char</span> ** )</div><div class="line">{</div><div class="line">sqlite3 * db;</div><div class="line"><span class="keyword">int</span> result;</div><div class="line"><span class="keyword">char</span> * errmsg = NULL;</div><div class="line"><span class="keyword">char</span> **dbResult; <span class="comment">//�� char ** ���ͣ�����*��</span></div><div class="line"><span class="keyword">int</span> nRow, nColumn;</div><div class="line"><span class="keyword">int</span> i , j;</div><div class="line"><span class="keyword">int</span> index;</div><div class="line"></div><div class="line">result = sqlite3_open( ��c:\\Dcg_database.db��, &db );</div><div class="line"><span class="keyword">if</span>( result != SQLITE_OK )</div><div class="line">{</div><div class="line"><span class="comment">//���ݿ�����ʧ��</span></div><div class="line"><span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">//���ݿ���������</span></div><div class="line"><span class="comment">//����ǰ���Ѿ������� MyTable_1 ��</span></div><div class="line"><span class="comment">//��ʼ��ѯ�������� dbResult �Ѿ��� char **�������ּ���һ�� & ȡ��ַ�������ݽ�ȥ�ľͳ��� char ***</span></div><div class="line">result = sqlite3_get_table( db, ��select * from MyTable_1��, &dbResult, &nRow, &nColumn, &errmsg );</div><div class="line"><span class="keyword">if</span>( SQLITE_OK == result )</div><div class="line">{</div><div class="line"><span class="comment">//��ѯ�ɹ�</span></div><div class="line">index = nColumn; <span class="comment">//ǰ��˵�� dbResult ǰ����һ���������ֶ����ƣ��� nColumn ������ʼ��������������</span></div><div class="line"><span class="built_in">printf</span>( ���鵽%d����¼\n��, nRow );</div><div class="line"></div><div class="line"><span class="keyword">for</span>(  i = <span class="number">0</span>; i &lt; nRow ; i++ )</div><div class="line">{</div><div class="line"><span class="built_in">printf</span>( ���� %d ����¼\n��, i+<span class="number">1</span> );</div><div class="line"><span class="keyword">for</span>( j = <span class="number">0</span> ; j &lt; nColumn; j++ )</div><div class="line">{</div><div class="line"><span class="built_in">printf</span>( ���ֶ���:%s  ?&gt; �ֶ�ֵ:%s\n��,  dbResult[j], dbResult [index] );</div><div class="line">++index; <span class="comment">// dbResult ���ֶ�ֵ�������ģ��ӵ�0�������� nColumn �C 1���������ֶ����ƣ��ӵ� nColumn ������ʼ�����涼���ֶ�ֵ������һ����ά�ı���ͳ�����б�ʾ������һ����ƽ����ʽ����ʾ</span></div><div class="line">}</div><div class="line"><span class="built_in">printf</span>( ������-\n�� );</div><div class="line">}</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">//������������ݿ���ѯ�Ƿ��ɹ������ͷ� char** ��ѯ������ʹ�� sqlite �ṩ�Ĺ������ͷ�</span></div><div class="line">sqlite3_free_table( dbResult );</div><div class="line"></div><div class="line"><span class="comment">//�ر����ݿ�</span></div><div class="line">sqlite3_close( db );</div><div class="line"><span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">}</div></pre></td></tr></table></figure>

<p>����������Ϊֹ��sqlite3 �ĳ����÷����������ˡ�<br>�����ϵķ����������� sql ���䣬��ȫ����Ӧ�������������ݿ�������</p>
]]></content>
    <summary type="html">
    <![CDATA[<h2 id="һ���汾">һ���汾</h2>
<p>�� www.sqlite.org ��վ�����ص����µ� sqlite �����ͱ����汾����д������ʱ�����´����� 3.3.17 �汾��<br>�ܾ�û��ȥ���� sqlite �]]>
    </summary>
    
      <category term="��������" scheme="http://yoursite.com/categories/%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[windows常见反调试]]></title>
    <link href="http://yoursite.com/2014/10/31/windows%E5%B8%B8%E8%A7%81%E5%8F%8D%E8%B0%83%E8%AF%95/"/>
    <id>http://yoursite.com/2014/10/31/windows常见反调试/</id>
    <published>2014-10-31T07:17:40.000Z</published>
    <updated>2014-10-31T12:46:28.000Z</updated>
    <content type="html"><![CDATA[<h2 id="1-_PEB">1. <strong>PEB</strong></h2>
<p>0×002    BeingDebugged<br>正常运行：0×0        调试态：0×1<br>0x00c    Ldr：指向堆内存区地址<br>调试状态堆内存全部填充为0xFEEEFEEE<br>0×018    ProcessHeap：指向HEAP结构体<br>0x00c    Flags    正常运行：0×2    调试态：0×50000062<br>0×010    ForceFlags    正常运行：0×2    调试态：0×40000060<br>0×068    NtGlobalFlag<br>正常运行：0×0        调试态：0×70<br>代码示例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor">#include </span></div><div class="line"><span class="preprocessor">#include</span></div><div class="line"><span class="keyword">extern</span> “C” BOOL WINAPI IsDebuggerPresent(VOID);</div><div class="line"><span class="keyword">int</span> main()</div><div class="line">{</div><div class="line">FARPROC pProc = NULL;</div><div class="line">LPBYTE pTeb = NULL;</div><div class="line">LPBYTE pPeb = NULL;</div><div class="line">LPBYTE pLdr = NULL;</div><div class="line">LPBYTE pHeap = NULL;</div><div class="line">DWORD dst[<span class="number">4</span>] = {<span class="number">0xEEFEEEFE</span>, <span class="number">0xEEFEEEFE</span>, <span class="number">0xEEFEEEFE</span>, <span class="number">0xEEFEEEFE</span>};</div><div class="line"><span class="comment">//BeingDebugged</span></div><div class="line"><span class="built_in">printf</span>(“BeingDebugged———\n”);</div><div class="line"><span class="keyword">if</span> (IsDebuggerPresent())</div><div class="line">{</div><div class="line"><span class="built_in">printf</span>(“Debugger Detected!\n”);</div><div class="line">}</div><div class="line"><span class="keyword">else</span></div><div class="line">{</div><div class="line"><span class="built_in">printf</span>(“No Debugger!\n”);</div><div class="line">}</div><div class="line"><span class="comment">//Ldr</span></div><div class="line"><span class="built_in">printf</span>(“\nLdr———\n”);</div><div class="line">pProc = GetProcAddress(GetModuleHandle(“ntdll.dll”), “NtCurrentTeb”);</div><div class="line">pTeb = (LPBYTE)(*pProc)();</div><div class="line">pPeb = (LPBYTE)*(LPDWORD)(pTeb + <span class="number">0</span>×<span class="number">30</span>);</div><div class="line">pLdr = (LPBYTE)*(LPDWORD)(pPeb + <span class="number">0xc</span>);</div><div class="line">__try</div><div class="line">{</div><div class="line"><span class="keyword">while</span> (<span class="number">1</span>)</div><div class="line">{</div><div class="line"><span class="keyword">if</span> (!<span class="built_in">memcmp</span>(dst, pLdr, <span class="keyword">sizeof</span>(dst)))</div><div class="line">{</div><div class="line"><span class="built_in">printf</span>(“Debugger Detected!\n”);</div><div class="line"><span class="keyword">break</span>;</div><div class="line">}</div><div class="line">pLdr++;</div><div class="line">}</div><div class="line">}</div><div class="line">__except (EXCEPTION_EXECUTE_HANDLER)</div><div class="line">{</div><div class="line"><span class="built_in">printf</span>(“No Debugger!\n”);</div><div class="line">}</div><div class="line"><span class="comment">//ProcessHeap</span></div><div class="line"><span class="built_in">printf</span>(“\nProcessHeap———\n”);</div><div class="line">pHeap = (LPBYTE)*(LPDWORD)(pPeb + <span class="number">0</span>×<span class="number">18</span>);</div><div class="line"><span class="keyword">if</span> (*(LPDWORD)(pHeap + <span class="number">0x0c</span>) == <span class="number">0</span>×<span class="number">50000062</span> || *(LPDWORD)(pHeap + <span class="number">0</span>×<span class="number">10</span>) == <span class="number">0</span>×<span class="number">40000060</span>)</div><div class="line">{</div><div class="line"><span class="built_in">printf</span>(“Debugger Detected!\n”);</div><div class="line">}</div><div class="line"><span class="keyword">else</span></div><div class="line">{</div><div class="line"><span class="built_in">printf</span>(“No Debugger!\n”);</div><div class="line">}</div><div class="line"><span class="comment">//NtGlobalFlag</span></div><div class="line"><span class="built_in">printf</span>(“\nNtGlobalFlag———\n”);</div><div class="line"><span class="keyword">if</span> (*(LPDWORD)(pPeb + <span class="number">0</span>×<span class="number">68</span>) == <span class="number">0</span>×<span class="number">70</span>)</div><div class="line">{</div><div class="line"><span class="built_in">printf</span>(“Debugger Detected!\n”);</div><div class="line">}</div><div class="line"><span class="keyword">else</span></div><div class="line">{</div><div class="line"><span class="built_in">printf</span>(“No Debugger!\n”);</div><div class="line">}</div><div class="line"><span class="built_in">printf</span>(“\n\n”);</div><div class="line"><span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">}</div></pre></td></tr></table></figure>

<h2 id="2-_NtQueryInformationProcess">2. <strong>NtQueryInformationProcess</strong></h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">NTSYSAPI NTSTATUS NTAPI NtQueryInformationProcess (</div><div class="line">HANDLE     ProcessHandle, 　　　　　　<span class="comment">// 进程句柄</span></div><div class="line">PROCESSINFOCLASS 　　InformationClass, <span class="comment">// 信息类型</span></div><div class="line">PVOID 　　　　　ProcessInformation, 　　　 <span class="comment">// 缓冲指针</span></div><div class="line">ULONG 　　　　ProcessInformationLength, <span class="comment">// 以字节为单位的缓冲大小</span></div><div class="line">PULONG 　　　ReturnLength OPTIONAL     <span class="comment">// 写入缓冲的字节数</span></div><div class="line">);</div></pre></td></tr></table></figure>

<p>第二个枚举参数中的三个域可以用来做反调试<br>ProcessDebugPort = 0×7<br>正常运行：0×0        调试态：0xFFFFFFFF<br>ProcessDebugObjectHandle = 0x1E<br>正常运行：NULL        调试态：调试对象句柄<br>ProcessDebugFlags = 0x1F<br>正常运行：0×1        调试态：0×0<br>代码示例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">proc = (NTQUERYINFORMATIONPROCESS)GetProcAddress(GetModuleHandle(“ntdll.dll”), “NtQueryInformationProcess”);</div><div class="line"><span class="comment">//ProcessDebugPort = 0×7</span></div><div class="line">(*proc)(GetCurrentProcess(), ProcessDebugPort, &dwRet, <span class="keyword">sizeof</span>(dwRet), NULL);</div><div class="line"><span class="keyword">if</span> (dwRet != <span class="number">0</span>)</div><div class="line">{</div><div class="line"><span class="built_in">printf</span>(“Debugger Detected!\n”);</div><div class="line">}</div><div class="line"><span class="keyword">else</span></div><div class="line">{</div><div class="line"><span class="built_in">printf</span>(“No Debugger!\n”);</div><div class="line">}</div><div class="line"><span class="comment">//ProcessDebugObjectHandle = 0x1e</span></div><div class="line">(*proc)(GetCurrentProcess(), ProcessDebugObjectHandle, &dwRet, <span class="keyword">sizeof</span>(dwRet), NULL);</div><div class="line"><span class="keyword">if</span> (dwRet != <span class="number">0</span>)</div><div class="line">{</div><div class="line"><span class="built_in">printf</span>(“Debugger Detected!\n”);</div><div class="line">}</div><div class="line"><span class="keyword">else</span></div><div class="line">{</div><div class="line"><span class="built_in">printf</span>(“No Debugger!\n”);</div><div class="line">}</div><div class="line"><span class="comment">//ProcessDebugFlags = 0x1f</span></div><div class="line">(*proc)(GetCurrentProcess(), ProcessDebugFlags, &dwRet, <span class="keyword">sizeof</span>(dwRet), NULL);</div><div class="line"><span class="keyword">if</span> (dwRet == <span class="number">0</span>)</div><div class="line">{</div><div class="line"><span class="built_in">printf</span>(“Debugger Detected!=%d\n”, dwRet);</div><div class="line">}</div><div class="line"><span class="keyword">else</span></div><div class="line">{</div><div class="line"><span class="built_in">printf</span>(“No Debugger!\n”);</div><div class="line">}</div></pre></td></tr></table></figure>

<h2 id="3-_NtQueryObject">3. <strong>NtQueryObject</strong></h2>
<p>当调试器调试一个进程时，会创建一个调试类型的内核对象，检测系统中是否有调试对象即可判断是否有进程正在被调试。<br>获取内核对象信息链表，遍历链表中对象类型，如果有DebugObject类型对象则说明有程序正在被调试。</p>
<h2 id="4-_ZwSetInformationThread">4. <strong>ZwSetInformationThread</strong></h2>
<p>隐藏线程，使调试器无法接收调试事件。<br>第二个参数是个枚举类型的，这个域可以用来反调试ThreadHideFromDebugger：0×11<br>代码示例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> main()</div><div class="line">{</div><div class="line">MYZWSETINFOMATIONTHREAD proc = NULL;</div><div class="line">proc = (MYZWSETINFOMATIONTHREAD)GetProcAddress(GetModuleHandle(“ntdll.dll”), “ZwSetInformationThread”);</div><div class="line">proc(GetCurrentThread(), ThreadHideFromDebugger, NULL, <span class="number">0</span>);</div><div class="line"><span class="built_in">printf</span>(“done\n”);</div><div class="line">system(“pause”);</div><div class="line"><span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">}</div></pre></td></tr></table></figure>

<h2 id="5-_DebugActiveProcessStop">5. <strong>DebugActiveProcessStop</strong></h2>
<p>这个函数可以把调试器与被调试进程的调试关系解除，这样调试器也就接收不到被调试进程的调试事件了。</p>
<h2 id="6-_FindWindow">6. <strong>FindWindow</strong></h2>
<p>通过这个函数获取调试器窗口的句柄，如果调试器窗口存在就会返回一个非零的值。</p>
<h2 id="7-_TLS回调">7. <strong>TLS回调</strong></h2>
<p>Tls回调函数会优先于EP代码执行，所以可以在函数中写入检测代码，在进程还没有开始运行之前就可以知道是否正在被调试。TLS其实不算反调试技术，只有在结合了其他反调试技术才会有反调试的效果。<br>代码示例:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor">#include </span></div><div class="line"><span class="preprocessor">#include</span></div><div class="line"><span class="keyword">void</span> NTAPI Tls_Callback(PVOID h, DWORD dwReason, PVOID pv)</div><div class="line">{</div><div class="line"><span class="keyword">if</span>( DLL_PROCESS_ATTACH == dwReason )</div><div class="line">{</div><div class="line"><span class="keyword">if</span> (IsDebuggerPresent())</div><div class="line">{</div><div class="line"><span class="built_in">printf</span>(“Debugger Detected!\n”);</div><div class="line">}</div><div class="line">}</div><div class="line">}</div><div class="line"><span class="preprocessor">#<span class="keyword">pragma</span> comment(linker, “/INCLUDE:__tls_used”)</span></div><div class="line"><span class="preprocessor">#<span class="keyword">pragma</span> data_seg(“.CRT$XLX”)</span></div><div class="line">PIMAGE_TLS_CALLBACK pTLS_CALLBACKs[] = { Tls_Callback, <span class="number">0</span> };</div><div class="line"><span class="preprocessor">#<span class="keyword">pragma</span> data_seg()</span></div><div class="line"><span class="keyword">int</span> main()</div><div class="line">{</div><div class="line"><span class="built_in">printf</span>(“tls callback anti-debug————\n\n”);</div><div class="line">system(“pause”);</div><div class="line"><span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">}</div></pre></td></tr></table></figure>

<h2 id="8-_SEH">8. <strong>SEH</strong></h2>
<p>1）<br>a.安装seh处理函数<br>b.故意触发一个异常，跳转到刚注册的seh处理函数中<br>c.在seh处理函数中写入检测代码<br>2）<br>a.SetUnhandledExceptionFilter更改默认顶层异常处理函数<br>b.触发异常，跳转到更改过的顶层异常处理函数中<br>c. 在seh处理函数中写入检测代码</p>
<h2 id="9-_进程快照">9. <strong>进程快照</strong></h2>
<p>CreateToolhelp32Snapshot、Process32First、Process32Next<br>这几个函数可以用来建立一个系统正在运行的进程快照，然后遍历进程快照查找是否有常见的调试器进程正在运行也可用作反调试。</p>
<p>本文章转至[三叶草]（<a href="http://syclover.sinaapp.com/?cat=4）" target="_blank" rel="external">http://syclover.sinaapp.com/?cat=4）</a></p>
]]></content>
    <summary type="html">
    <![CDATA[<h2 id="1-_PEB">1. <strong>PEB</strong></h2>
<p>0×002    BeingDebugged<br>正常运行：0×0        调试态：0×1<br>0x00c    Ldr：指向堆内存区地址<br>调试状态堆内存全部填充为0x]]>
    </summary>
    
      <category term="安全技术" scheme="http://yoursite.com/categories/%E5%AE%89%E5%85%A8%E6%8A%80%E6%9C%AF/"/>
    
  </entry>
  
</feed>
